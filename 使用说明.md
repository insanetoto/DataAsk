# 百惟数问 - 智能数据问答平台

## 项目概述

百惟数问是基于 **Vanna AI** 开源框架构建的企业级智能数据问答平台，集成了 MySQL、Redis 等主流中间件，支持通过自然语言查询数据库并自动生成可视化图表。

## 技术栈

- **后端框架**: Flask (Python)
- **AI引擎**: Vanna AI (自然语言转SQL)
- **数据库**: MySQL (支持连接池)
- **缓存**: Redis (查询结果缓存、SQL缓存)
- **向量数据库**: ChromaDB (用于AI训练)
- **API**: RESTful API 设计

## 项目结构

```
DataAsk/
├── app.py                  # 主应用入口
├── config.py              # 配置文件
├── requirements.txt       # 依赖包
├── env.example            # 环境变量示例
├── .gitignore            # Git忽略文件
├── services/             # 服务模块
│   ├── __init__.py
│   ├── database.py       # MySQL数据库服务
│   ├── redis_service.py  # Redis缓存服务
│   └── vanna_service.py  # Vanna AI服务
├── api/                  # API接口
│   ├── __init__.py
│   └── routes.py         # API路由
└── 产品说明手册.md       # 产品功能说明
```

## 快速开始

### 1. 环境准备

确保已安装以下服务：
- Python 3.8+
- MySQL 5.7+
- Redis 6.0+

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

### 3. 配置环境变量

复制环境变量示例文件并根据实际情况修改：

```bash
cp env.example .env
```

编辑 `.env` 文件，配置以下信息：

```bash
# MySQL数据库配置
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=your-mysql-password
MYSQL_DATABASE=dataask

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# 阿里云百炼平台API配置 (必须)
OPENAI_API_KEY=sk-67ff53e84a0a4868bc4bf41e833e4ca3
OPENAI_API_BASE=https://dashscope.aliyuncs.com/compatible-mode/v1
```

### 4. 初始化数据库

创建名为 `dataask` 的MySQL数据库（或根据配置修改）。

### 5. 启动应用

```bash
python app.py
```

应用将在 `http://localhost:5000` 启动。

## API 接口说明

### 健康检查
```http
GET /api/v1/health
```

### 智能问答
```http
POST /api/v1/ask
Content-Type: application/json

{
    "question": "上个月销售额最高的三个产品是什么？",
    "use_cache": true
}
```

### 生成SQL
```http
POST /api/v1/generate_sql
Content-Type: application/json

{
    "question": "查询所有用户的订单总数",
    "use_cache": true
}
```

### 执行SQL
```http
POST /api/v1/execute_sql
Content-Type: application/json

{
    "sql": "SELECT COUNT(*) FROM users"
}
```

### 训练模型
```http
POST /api/v1/train
Content-Type: application/json

{
    "question": "查询用户总数",
    "sql": "SELECT COUNT(*) FROM users"
}
```

### 自动训练（从数据库Schema）
```http
POST /api/v1/auto_train
```

### 获取数据库信息
```http
GET /api/v1/database/info
```

### 清除缓存
```http
POST /api/v1/cache/clear
Content-Type: application/json

{
    "type": "all"  // all, query, sql
}
```

## 核心功能

### 1. 智能问答
- 支持中文自然语言查询
- 自动生成SQL语句
- 智能缓存查询结果
- 返回结构化数据

### 2. 缓存机制
- **SQL缓存**: 缓存相同问题生成的SQL（2小时过期）
- **查询结果缓存**: 缓存SQL执行结果（1小时过期）
- 支持手动清除缓存

### 3. 数据库集成
- MySQL连接池管理
- 自动获取数据库Schema
- 支持查询安全检查（仅允许SELECT）

### 4. AI训练
- 支持DDL语句训练
- 支持文档训练
- 支持问题-SQL对训练
- 自动从数据库Schema训练

## 配置说明

### 数据库配置
- 支持连接池配置
- 自动重连机制
- UTF-8编码支持

### Redis配置
- 支持密码认证
- 可配置数据库编号
- 连接超时设置

### Vanna AI配置
- 使用阿里云百炼平台qwen-turbo模型
- 支持OpenAI兼容的API格式
- 集成ChromaDB向量存储
- 支持自定义API基础URL

## 日志记录

应用自动记录日志到 `app.log` 文件，包含：
- 服务初始化信息
- API请求记录
- 错误信息记录
- SQL执行记录

## 注意事项

1. **阿里云API密钥**: 必须配置有效的阿里云百炼平台API密钥才能使用AI功能
2. **数据库权限**: 确保MySQL用户有足够权限访问目标数据库
3. **Redis连接**: 确保Redis服务正常运行并可连接
4. **安全考虑**: 生产环境请修改默认密钥和端口配置
5. **中文支持**: 所有数据库连接使用UTF-8编码

## 故障排除

### 常见问题

1. **服务启动失败**
   - 检查MySQL和Redis服务是否运行
   - 确认配置文件中的连接信息正确

2. **AI功能不可用**
   - 检查阿里云百炼平台API密钥是否有效
   - 确认API基础URL配置正确
   - 确认网络连接正常

3. **数据库连接失败**
   - 检查MySQL服务状态
   - 确认用户名密码正确
   - 检查数据库是否存在

4. **缓存问题**
   - 检查Redis服务状态
   - 尝试清除缓存重新开始

## 开发指南

### 添加新的API接口
在 `api/routes.py` 中添加新的路由函数。

### 扩展服务功能
在 `services/` 目录下创建新的服务模块。

### 修改数据库连接
编辑 `services/database.py` 中的连接配置。

## 许可证

本项目基于产品说明手册要求开发，仅用于学习和演示目的。 