# 工作流增强功能说明

## 📋 功能概述

本次增强在原有工作流功能基础上，新增了多工作域支持、权限控制、节点类型扩展等功能，实现了企业级工作流管理能力。

## 🎯 主要特性

### 1. 多工作域支持
- **5个预置工作域**：系统管理、业务流程、数据处理、客服服务、AI应用
- **工作域隔离**：不同工作域的工作流独立管理
- **灵活分类**：支持主分类和子分类的层级化管理

### 2. 增强的节点类型
- **页面节点**：导航到指定页面路径
- **按钮节点**：自动点击页面按钮元素
- **API节点**：调用后端REST API接口
- **审批节点**：人工审批流程控制
- **条件节点**：支持分支条件判断
- **脚本节点**：执行Python/Bash/SQL脚本

### 3. 细粒度权限控制
- **工作域级权限**：控制用户对整个工作域的访问
- **工作流级权限**：控制单个工作流的操作权限
- **节点级权限**：控制特定节点的执行权限
- **多主体支持**：用户、角色、组织多层次权限分配

### 4. 可视化管理界面
- **工作域选择器**：直观的工作域切换界面
- **增强表格展示**：丰富的状态标签和统计信息
- **响应式设计**：支持移动端访问
- **实时状态更新**：执行状态实时反馈

## 🗄️ 数据库变更

### 扩展现有表
```sql
-- sys_workflow 表新增字段
workspace varchar(50)           -- 所属工作域
sub_category varchar(50)        -- 子分类
trigger_type enum(...)          -- 触发方式
version varchar(20)             -- 版本号

-- workflow_steps 表新增字段
node_type enum(...)             -- 节点类型
position_x/position_y decimal   -- 流程图坐标
icon/color varchar              -- 显示样式
skip_on_failure tinyint         -- 失败处理
status enum(...)                -- 节点状态
```

### 新增核心表
```sql
workflow_workspaces            -- 工作域管理
workflow_permissions           -- 权限控制
workflow_step_connections      -- 节点连接关系
```

## 🚀 启动方式

### 1. 后端服务
```bash
# 已自动集成到主应用
# 访问路径：/api/workflow-enhancement/*
python app.py
```

### 2. 前端界面
```bash
# 导航到：系统管理 > 工作流管理
# 直接访问：http://localhost:4200/sys/workflow
```

## 📊 API 接口

### 工作域管理
```
GET  /api/workflow-enhancement/workspaces                    # 获取工作域列表
GET  /api/workflow-enhancement/workspaces/{code}/categories  # 获取分类列表
```

### 工作流管理
```
GET  /api/workflow-enhancement/workflows                     # 获取工作流列表
POST /api/workflow-enhancement/workflows                     # 创建工作流
PUT  /api/workflow-enhancement/workflows/{id}                # 更新工作流
```

### 节点管理
```
GET  /api/workflow-enhancement/workflows/{id}/steps          # 获取节点列表
POST /api/workflow-enhancement/workflows/{id}/steps          # 创建节点
```

### 权限管理
```
GET  /api/workflow-enhancement/permissions/{type}/{id}       # 获取权限配置
```

### 配置查询
```
GET  /api/workflow-enhancement/node-types                    # 获取节点类型
GET  /api/workflow-enhancement/statistics                    # 获取统计信息
```

## 🎨 节点配置示例

### 页面节点
```json
{
  "type": "page",
  "route": "/customer-service/workbench",
  "params": {"status": "pending"},
  "target": "_current"
}
```

### 按钮节点
```json
{
  "type": "button",
  "selector": "#approve-btn",
  "action": "click",
  "waitFor": ".success-message"
}
```

### API节点
```json
{
  "type": "api",
  "url": "/api/workflow/execute",
  "method": "POST",
  "headers": {"Content-Type": "application/json"},
  "data": {}
}
```

### 审批节点
```json
{
  "type": "approval",
  "approvers": ["user_123", "role_manager"],
  "deadline_hours": 24,
  "parallel": false
}
```

## 🔧 功能使用

### 1. 选择工作域
- 在工作流管理页面顶部选择工作域
- 支持"全部"查看所有工作域
- 显示每个工作域的工作流数量

### 2. 创建工作流
- 选择目标工作域和分类
- 配置基本信息（名称、描述、版本等）
- 设置触发方式和执行参数
- 添加工作流步骤和连接关系

### 3. 配置节点
- 选择节点类型（页面、按钮、API等）
- 配置节点参数和执行条件
- 设置节点权限和异常处理
- 定义节点间的连接关系

### 4. 权限管理
- 为用户/角色分配工作域权限
- 设置工作流级别的操作权限
- 配置节点级别的执行权限
- 支持权限继承和条件权限

## 📈 统计信息

系统提供以下统计数据：
- 工作域工作流分布
- 执行成功率统计
- 节点类型使用情况
- 用户操作日志

## 🔒 安全特性

- **登录验证**：所有API需要用户登录
- **权限检查**：操作前验证用户权限
- **数据隔离**：工作域间数据完全隔离
- **审计日志**：记录所有关键操作

## 🚀 未来扩展

### 可视化流程设计器
- 拖拽式节点创建
- 实时连接线绘制
- 可视化执行状态
- 流程模板库

### 高级功能
- 工作流版本控制
- 批量操作支持
- 定时任务调度
- 外部系统集成

## 📞 技术支持

如有问题或建议，请通过以下方式联系：
- 查看日志：`tail -f app.log`
- 数据库检查：使用MySQL客户端连接
- 前端调试：浏览器开发者工具

---

**版本信息**：v1.0.0  
**更新时间**：2025-01-19  
**兼容性**：完全向后兼容现有工作流功能 